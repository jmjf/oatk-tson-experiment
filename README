# oatk-tson-experiment

Trying to figure out how to use tson generated by openapi-transformer-toolkit with Fastify.

## Issue I'm seeing

The TSON output from openapi-transformer-toolkit dereferences `$ref` tags. The dereferenced
tag include the `$id` for the referenced schema. If two schemas use the same `$ref`, Fastify
(Ajv) throws an error because the reference resolves to more than one schema.

## Example output

```text
[16:32:01.366] ERROR (7811): reference "User.json" resolves to more than one schema
    err: {
      "type": "Error",
      "message": "reference \"User.json\" resolves to more than one schema",
      "stack":
          Error: reference "User.json" resolves to more than one schema
              at ambiguos (/workspace/node_modules/ajv/dist/compile/resolve.js:151:16)
              at Ajv.addRef (/workspace/node_modules/ajv/dist/compile/resolve.js:118:23)
              at /workspace/node_modules/ajv/dist/compile/resolve.js:109:29
              at _traverse (/workspace/node_modules/json-schema-traverse/index.js:69:5)
              at _traverse (/workspace/node_modules/json-schema-traverse/index.js:80:13)
              at _traverse (/workspace/node_modules/json-schema-traverse/index.js:83:9)
              at _traverse (/workspace/node_modules/json-schema-traverse/index.js:80:13)
              at module.exports (/workspace/node_modules/json-schema-traverse/index.js:14:3)
              at Ajv.getSchemaRefs (/workspace/node_modules/ajv/dist/compile/resolve.js:103:5)
              at Ajv._addSchema (/workspace/node_modules/ajv/dist/core.js:450:51)
    }
```

## Use

Install with `npm i`  then `npm run everything`, which

- Generates TSON from `openapi-tson.yaml` to `./tson`
- Compiles the server to `./dist`
- Runs the compiled server

## Workaround I found

Edit the `.ts` files in `./tson` and comment out the `$id` lines on inner schemas.

- In `Comment.ts`, comment out the `$id` for User.json.
- In `Post.ts`, comment out `$id`s for User.json and Comment.json.
- `npm run build && npm run start`

Not sustainable, but it demonstrates that this approach works with a small change.

OTOH, there's probably a better approach.
